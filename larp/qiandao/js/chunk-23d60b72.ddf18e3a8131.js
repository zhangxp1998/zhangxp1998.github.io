(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-23d60b72"],{"158b":function(t,e,a){"use strict";a.d(e,"a",(function(){return c})),a.d(e,"b",(function(){return n}));a("f8c9");var s=a("0ef7"),i=a("8d17");function r(t){return s["l"].get("/action/get-url-val",t)}function o({k:t,v:e}){const a={k:t,v:e};return s["l"].post("/action/set-url-val",a)}async function c(t){const e=i["a"].obj2query(t),{k:a}=await o({v:e});return"hash="+a}async function n(t){if(!t)return{};try{const e=decodeURIComponent(t),a=e.split("&");let s={};if(a.forEach(t=>{const[e,a]=t.split("=");s[e]=a}),s.hash){const{data:t}=await r({k:s.hash}),e=await n(t);Reflect.deleteProperty(s,"hash"),s={...e,...s}}return s}catch(e){return console.log("error",e),{}}}},8948:function(t,e,a){},9851:function(t,e,a){},"99f9":function(t,e,a){"use strict";a("9851")},afa0:function(t,e,a){},cda2:function(t,e,a){"use strict";a("afa0")},d0b9:function(t,e,a){"use strict";a.r(e);var s=function(){var t=this,e=t._self._c;return e("div",{staticClass:"category-publish"},[e("car-owner",{attrs:{carOwnerInfo:t.carOwnerInfo,carDesc:t.carDesc}}),e("intro",{attrs:{totalPrice:t.totalPrice,calcedTotalPrice:t.calcedTotalPrice,megaSpuName:t.megaSpuName},on:{toMegaSpu:t.toMegaSpu}}),t.selectTarget&&t.targetSpuList[t.selectTarget]&&t.targetSpuList[t.selectTarget].list?e("div",{staticClass:"category-spus"},t._l(t.targetSpuList[t.selectTarget].list,(function(a,s){return e("Spu",{key:s,attrs:{spu:a,index:s,averagePrice:t.averagePrice,standardPrice:+t.standardPrice},on:{inToCar:t.inToCar,toAnotherCar:t.toAnotherCar,setData:e=>t.setData(s,e)}})})),1):t._e(),t.isSelfCar?e("div",{staticClass:"publish"},[e("div",{staticClass:"publish-left",on:{click:t.handleOrder}},[t._v("查看订单")]),e("div",{staticClass:"publish-right"},[e("div",{staticClass:"publish-right-edit",on:{click:t.handleEdit}},[t._v("编辑拼车")]),e("div",{staticClass:"publish-right-poster",on:{click:t.handlePoster}},[t._v("生成海报")])]),e("div",{staticClass:"publish-bgcover"})]):e("div",[e("div",{staticClass:"car-btn",on:{click:t.createMyCar}},[e("span",{staticClass:"car-btn-label"},[t._v("创建我的拼车")])]),e("div",{staticClass:"im",on:{click:t.msgToSeller}},[e("img",{staticClass:"im-icon",attrs:{src:"https://cdn.qiandaoapp.com/interior/images/154eddb99154b4a707fe7aabc0fe4345.png",alt:""}}),e("span",{staticClass:"im-label"},[t._v("联系卖家")])])]),e("PosterPop",{ref:"PosterPopRef",attrs:{remark:t.remark,price:t.averagePrice,categoryId:t.categoryId,megaSpuId:t.megaSpuId,sales:t.sales,propertyId:t.propertyId},on:{init:t.initData}})],1)},i=[],r=(a("e17f"),a("2241")),o=(a("14d9"),a("2f62")),c=(a("5af3"),a("df74")),n=function(){var t=this,e=t._self._c,a=t._self._setupProxy;return e("div",{staticClass:"owner"},[e("div",{staticClass:"owner-top"},[e("div",{staticClass:"user"},[e("img",{staticClass:"user-avatar",attrs:{src:t.carOwnerInfo.avatar,alt:""}}),e("span",{staticClass:"user-name otext"},[t._v(t._s(t.carOwnerInfo.nickName))])]),e("div",{staticClass:"location"},[e("img",{staticClass:"location-icon",attrs:{src:"https://cdn.qiandaoapp.com/interior/images/8102cd9bab7e3efc27e4f69918e7d085.png",alt:""}}),t.carOwnerInfo.city?e("span",{staticClass:"location-name"},[t._v(" "+t._s(t.carOwnerInfo.city)+" ")]):e("span",{staticClass:"location-name"},[t._v("设置邮费")])])]),e("div",{staticClass:"owner-info"},[e("div",{staticClass:"content"},[e("div",{staticClass:"content-left otext2"},[t._v(t._s(t.carDesc))]),e("div",{staticClass:"content-qrcode"},[e("img",{staticClass:"content-qrcode-img",attrs:{src:a.qrcode,alt:""}})])])])])},l=[],d=(a("d9e2"),a("2b0e")),u=a("158b"),p=a("cf63"),g={__name:"car-owner",props:{carOwnerInfo:{type:Object,default:()=>({})},carDesc:{type:String,default:""}},setup(t){const e=t,{proxy:a}=Object(d["getCurrentInstance"])(),{pkg:s}=a.$route.query,i=Object(d["ref"])(),r=t=>new Promise((e,a)=>{const s=new Image;s.onload=function(){var t=document.createElement("canvas");t.width=this.naturalWidth,t.height=this.naturalHeight,t.getContext("2d").drawImage(s,0,0);const a=t.toDataURL("image/png");e(a)},s.setAttribute("crossOrigin","Anonymous"),s.src=t,s.onerror=()=>{a(new Error("图片流异常"))}}),o=async()=>{const t=await Object(u["a"])({test:123});console.log("proxy.$route.fullPath====",a.$route.fullPath);const e=await Object(u["a"])({url:`${p["a"].web}${a.$route.fullPath}&${t}`,forceLogin:"YES"});i.value=await r(`https://api.qiandao.cn/poster/wx/get-qr-code?page=modules%2Fpages%2Fweb-view%2Findex&scene=${encodeURIComponent(e)}&packageId=1030`)};return o(),{__sfc:!0,proxy:a,pkg:s,qrcode:i,props:e,urlToBase64:r,generateQrocde:o}}},h=g,f=(a("cda2"),a("0c7c")),v=Object(f["a"])(h,n,l,!1,null,null,null),m=v.exports,S=function(){var t=this,e=t._self._c,a=t._self._setupProxy;return e("div",{staticClass:"intro"},[e("div",{staticClass:"intro-left"},[e("div",{staticClass:"title"},[t._v("千岛小卡｜五⭐️包装免费送")]),e("div",{staticClass:"desc",on:{click:a.toMegaSpu}},[t._v(" "+t._s(t.megaSpuName)+" "),e("img",{staticClass:"desc-arrow",attrs:{src:"https://cdn.qiandaoapp.com/interior/images/8b52bb042f6b047b344d3f82ded39da4.png",alt:""}})])]),e("div",{staticClass:"intro-right"},[e("div",{staticClass:"title"},[t._v("总价")]),e("div",{staticClass:"desc"},[t._v(" ¥"+t._s(+t.totalPrice>0?t.totalPrice:t.calcedTotalPrice)+" ")])])])},I=[],w={__name:"intro",props:{listData:{type:Array,default:()=>[]},megaSpuName:{type:String,default:""},totalPrice:{type:String,default:"0"},calcedTotalPrice:{type:Number,default:0}},emits:["toMegaSpu"],setup(t,{emit:e}){const a=t,s=()=>{e("toMegaSpu")};return{__sfc:!0,props:a,emits:e,toMegaSpu:s}}},y=w,C=(a("d951"),Object(f["a"])(y,S,I,!1,null,null,null)),P=C.exports,b=a("1b64"),_=a("ccbb"),O=a("a37c"),$=a("7f29"),T=a("4cce"),k=a("a382"),L={components:{CarOwner:m,Intro:P,Spu:b["a"],PosterPop:c["a"]},data(){return{show:!0,categoryId:"",megaSpuId:"",megaSpuName:"",carDesc:"",standardPrice:0,standardtotalPricePrice:0,averagePrice:0,totalPrice:0,sales:{total:0,list:[]},propertyId:O["d"]?"112350042":"1436288",targetSpuList:null,profiles:[],selectTarget:null,specId:O["d"]?18741:151607,isShowDialog:!0,spus:[],products:[],remark:"",storage:{},carOwnerInfo:{}}},async created(){const{id:t,megaSpuId:e,megaSpuName:a,carDesc:s,standardPrice:i,totalPrice:r}=this.$route.query;(t||e)&&(this.categoryId=t,this.megaSpuId=e,this.megaSpuName=decodeURIComponent(a),this.carDesc=s,this.totalPrice=r,this.standardPrice=i,this.getStorage(),await this.initData(),await this.getCarOwnerInfo())},mounted(){console.log("this.me",this.me),this.totalPrice||this.$refs.SetAveragePriceRef.changeShow(!0)},computed:{...Object(o["mapState"])("user",["me"]),...Object(o["mapState"])("app",["app"]),calcedTotalPrice(){const t=JSON.parse(JSON.stringify(this.targetSpuList));let e=0;for(const a in t)t[a].list.forEach(t=>{e+=t.data.price});return parseFloat(e.toFixed(2))},isSelfCar(){var t,e;const{carOwnerId:a}=this.$route.query;return a===(null===(t=this.me)||void 0===t||null===(e=t.id)||void 0===e?void 0:e.toString())},adjustPrice(){const{selectTarget:t,targetSpuList:e}=this;let a=0;return t&&null!==e&&void 0!==e&&e[t]?(e[t].list.forEach((t,e)=>{a+=+t.data.price}),Object($["a"])(a,2)):0}},methods:{async getCarOwnerInfo(){const{carOwnerId:t}=this.$route.query,e=await T["a"].getUserNew({userId:t});this.carOwnerInfo=e.data,console.log("res=--==-=",e)},async initData(){this.$loading.show({title:"获取数据中"}),await this.loadProducts(),await this.getSpuList(),this.$loading.hide()},async loadProducts(){try{const{megaSpuId:t,categoryId:e}=this,{carOwnerId:a}=this.$route.query,s={userId:a,categoryId:e,megaSpuId:t,status:"ON_SALE,OFF_SALE"},{data:{products:i=[]}}=await _["a"].getProductsByCategory(s);this.products=i.filter(t=>t.spec.find(t=>+t.id===this.specId))}catch(t){console.log(t)}this.isLoading=!1},async getSpuList(){let t=0;const e=async()=>{const{megaSpuId:a,categoryId:s}=this;var i={model:"CHANNEL_4COLUMNS",categoryId:s,categorySpuId:a,limit:20,propertyIds:[this.propertyId],offset:this.offset,orderBy:"latest"};try{const{data:a}=await _["a"].getSpuList(i);t=a.count,this.spus=this.offset?this.spus.concat(a.list.reverse()||[]):a.list.reverse(),this.offset=this.spus.length,t>this.offset&&await e()}catch(r){console.error(r)}};await e(),this.setSpus(this.spus)},setSpus(t=[]){const{products:e,averagePrice:a}=this,s={};t.forEach(t=>{var i,r;const o=null!==t&&void 0!==t&&null!==(i=t.profiles)&&void 0!==i&&i.length?t.profiles.find(t=>t.propertyId===this.propertyId):[];if(null!==o&&void 0!==o&&null!==(r=o.profiles)&&void 0!==r&&r.length)o.profiles.forEach(i=>{s[i.targetId]||(s[i.targetId]={info:i,list:[]});const r=e.find(e=>e.spuInfo.spuId===t.id),o=this.getProductData(r,t,a);s[i.targetId].list.push(o)});else{s["0"]||(s["0"]={list:[]});const i=e.find(e=>e.spuInfo.spuId===t.id),r=this.getProductData(i,t,a);s["0"].list.push(r)}}),this.targetSpuList=s;for(const i in this.targetSpuList)if(i)return void(this.selectTarget=i);this.$forceUpdate()},getProductData(t,e,a=0){const s={cover:e.cover,name:e.name,data:{id:null===t||void 0===t?void 0:t.productId,attachments:[],anotherCount:(null===t||void 0===t?void 0:t.anotherCount)||0,price:a&&null!==t&&void 0!==t&&t.price?Math.round(100*(t.price-a))/100:(null===t||void 0===t?void 0:t.price)||0,remark:"",specValueIds:[this.specId],spuId:e.id,status:null!==t&&void 0!==t&&t.status?null===t||void 0===t?void 0:t.status:(null===t||void 0===t?void 0:t.count)>0?"ON_SALE":"OFF_SALE",stock:"OFF_SALE"===(null===t||void 0===t?void 0:t.status)?0:(null===t||void 0===t?void 0:t.count)||0,tagIds:"",type:"spu"}};return s},setData(t,e){const a=this.targetSpuList[this.selectTarget].list;a[t].data[e.key]=e.num,this.targetSpuList[this.selectTarget].list=a,this.$forceUpdate()},inToCar(t){this.isSelfCar?k["c"].show({icon:"none",title:"不能上自己的车哦"}):(Object(r["a"])({title:"正在为您占位...",message:"请尽快支付以避免车位被他人抢占",showConfirmButton:!1}),setTimeout(()=>{r["a"].close();const{carOwnerId:e}=this.$route.query;this.navigateTo({url:`/pages-market/orders/make?sellerId=${e}&singleProductId=${t.data.id}`})},3e3))},handleOrder(){this.navigateTo({url:"/modules/pages-order/list/index?listType=sell"})},handleEdit(){let t=p["a"].web+"/plugin/xiaoka-publish";t=`${t}?megaSpuId=${this.megaSpuId}&megaSpuName=${encodeURIComponent(this.megaSpuName)}`,this.navigateTo({url:`/modules/pages/web-view/index?url=${encodeURIComponent(t)}&ut=true`})},createMyCar(){this.navigateTo({url:`/modules/pages/web-view/index?url=${encodeURIComponent(p["a"].web+"/plugin/xiaoka-publish/list")}&ut=true`})},msgToSeller(){const{carOwnerId:t}=this.$route.query;this.navigateTo({url:`/modules/pages-messenger/messenger/message/list?toUserId=${t}&_fromId=${this.me.id}`})},handlePoster(){k["c"].show({icon:"none",title:"请手动截图以保存海报"})},toMegaSpu(){const{megaSpuId:t}=this.$route.query;this.navigateTo({url:"/pages-market/spu/index?id="+t})},toAnotherCar(t){this.navigateTo({url:`/pages-market/spu/index?spuId=${t.data.spuId}&defaultTab=product`})},async handlePublish(){this.$loading.show({title:"提交中"});const t=JSON.parse(JSON.stringify(this.targetSpuList)),e=[],a=[],s={total:0,list:[]};for(const r in t)s.total+=t[r].list.length||0,t[r].list.forEach(t=>{var i;t.data.price=this.averagePrice+ +t.data.price,t.data.status=(null===(i=t.data)||void 0===i?void 0:i.stock)>0?"ON_SALE":"OFF_SALE",t.data.id?a.push(t.data):e.push(t.data),s.list.length<3&&s.list.push(t)});this.sales=s;try{if(null!==e&&void 0!==e&&e.length){await _["a"].updateProductMulti({args:e})}if(null!==a&&void 0!==a&&a.length){await _["a"].updateC2cProductsByCategory(a)}this.$refs.PosterPopRef.changeShow(!0)}catch(i){this.$loading.show({title:i.message})}finally{this.$loading.hide();const{categoryId:t,megaSpuId:e}=this,a={categoryId:t,megaSpuId:e};await _["a"].createUserPoster(a)}},handleChangeTaraget(t){this.selectTarget=t.targetId},setTotalPrice(t){console.log("price",t),this.setStorage("totalPrice",+t),this.$refs.SetAveragePriceRef.changeShow(!1)},setStorage(t,e){const a=this.categoryId||this.megaSpuId;var s;a&&(null!==(s=this.storage)&&void 0!==s&&s[a]||(this.storage[a]={}),t&&e&&(this.storage[a][t]=e,this[t]=e),window.localStorage.setItem("XIAOKA_PUBLISH",JSON.stringify(this.storage)))},async getStorage(){var t;this.storage=JSON.parse(window.localStorage.getItem("XIAOKA_PUBLISH"))||{};const e=this.categoryId||this.megaSpuId,a=null===(t=this.storage)||void 0===t?void 0:t[e];console.log("res===",a)},setCount(t){this.$loading.show({title:"调整余量"});const{targetSpuList:e}=this;if(this.targetSpuList)for(const a in e)e[a].list.forEach((s,i)=>{s.data.stock=t,e[a].list[i]=s});this.$refs.SetAveragePriceRef.changeShow(!1),this.$loading.hide()}}},N=L,x=(a("99f9"),Object(f["a"])(N,s,i,!1,null,null,null));e["default"]=x.exports},d44e:function(t,e,a){var s=a("9bf2").f,i=a("1a2d"),r=a("b622"),o=r("toStringTag");t.exports=function(t,e,a){t&&!a&&(t=t.prototype),t&&!i(t,o)&&s(t,o,{configurable:!0,value:e})}},d951:function(t,e,a){"use strict";a("8948")},f8c9:function(t,e,a){var s=a("23e7"),i=a("da84"),r=a("d44e");s({global:!0},{Reflect:{}}),r(i.Reflect,"Reflect",!0)}}]);